<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeConnect | Goals</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
</head>
<body>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div role="alert">
      {% for category, message in messages %}
        <div id="flash-message" class="alert transition-opacity duration-1000 opacity-100
                    {% if category == 'success' %}
                      alert-success
                    {% elif category == 'warning' %}
                      alert-warning
                    {% elif category == 'info' %}
                      alert-info
                    {% else %}
                      alert-error
                    {% endif %}
                    ">
          {% if category == 'success' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          {% elif category == 'warning' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          {% elif category == 'info' %}
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 shrink-0 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          {% endif %}
          <span>{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="navbar bg-base-100 shadow-sm fixed z-100">
  <div class="navbar-start">
    <div class="drawer">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />
      <div class="drawer-content">
        <label for="my-drawer" tabindex="0" role="button" class="btn btn-ghost btn-circle drawer-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
          </svg>
        </label>
      </div>
      <div class="drawer-side">
        <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
        <ul class="menu bg-base-200 text-base-content min-h-full w-80 p-4">
          <li><a href="/">Home</a></li>
          <li><a href="/chat">Chat</a></li>
          <li><a href="/goals">Goals</a></li>
          <li><a href="/leaderboard">Leaderboard</a></li>
          {% if is_admin_user() %}
          <li><a href="/admin/users">Admin Panel</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  <div class="navbar-center">
    <a id="logo" class="btn btn-ghost text-xl">CodeConnect</a>
  </div>
  <div class="navbar-end">
    {% if 'user_email' in session %}
      <div class="drawer-end">
        <input id="my-drawer-4" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content">
          <label for="my-drawer-4" class="btn btn-ghost btn-circle cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 
                4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 
                19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 
                6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 
                0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 
                2.625 2.625 0 0 1 5.25 0Z" />
            </svg>
          </label>
        </div>
        <div class="drawer-side">
          <label for="my-drawer-4" aria-label="close sidebar" class="drawer-overlay"></label>
          <ul class="menu bg-base-200 text-base-content min-h-full flex flex-col items-center justify-start w-80 p-4">
            <div class="tabs tabs-box">
              <input type="radio" id="tab-add-friends" name="my_tabs_1" class="tab" aria-label="Add friends" checked="checked" />
              <input type="radio" id="tab-outgoing-requests" name="my_tabs_1" class="tab" aria-label="Outgoing requests" />
            </div>
            <div id="add-friends-content" class="flex justify-center items-center p-4 w-full">
              <form method="POST" action="{{ url_for('send_friend_request') }}">
                <label class="input max-w-50">
                  <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.3-4.3"></path>
                    </g>
                  </svg>
                  <input type="search" class="grow" name="email" placeholder="Add users by email..." required />
                </label>
                <button type="submit" class="hidden">Search</button>
              </form>
            </div>
            <div id="outgoing-requests-content" class="hidden flex flex-col items-center w-full p-4">
              <ul id="outgoing-requests" class="w-full"></ul>
            </div>
          </ul>
        </div>
      </div>
      <div class="drawer-end">
        <input id="inbox-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content">
          <label for="inbox-drawer" class="btn btn-ghost btn-circle cursor-pointer">
            <div class="btn btn-ghost btn-circle">
              <div class="indicator">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" />
                </svg>
                <span id="request-count-badge" class="badge badge-xs badge-error indicator-item"></span>
              </div>
            </div>
          </label>
        </div>
        <div class="drawer-side z-10">
          <label for="inbox-drawer" aria-label="close inbox" class="drawer-overlay"></label>
          <div class="menu bg-base-100 text-base-content min-h-full flex flex-col items-center justify-start w-80 p-4">
            <h2 class="text-xl font-bold mb-4">Inbox:</h2>
            <ul id="friend-requests" class="w-full"></ul>
          </div>
        </div>
      </div>
      <div class="dropdown lg:dropdown-center dropdown-end">
        <div role="button" tabindex="0"  class="flex px-2 items-center justify-center btn btn-ghost">
        <div class="btn btn-ghost btn-circle avatar">
          <div class="w-10 rounded-full">
            <img alt="Profile photo" src="{{ current_user.profile_photo }}" />
          </div>
        </div>
        <span id="points-display" class="text-lg font-semibold lg:block hidden">{{ points }}</span>
        <img src="/static/images/money-icon.png" alt="currency icon" class="lg:inline-block hidden w-8 h-8" />
        </div>
        <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-1 mt-3 w-40 p-2 shadow">
          <li class="lg:hidden block">
            <div class="gap-1">
             <span id="points-display" class="font-semibold inline-block lg:hidden">{{ points }}</span>
            <img src="/static/images/money-icon.png" alt="currency icon" class="inline-block lg:hidden w-6 h-6" />
            </div>
          </li>
          <li><a href="/profile" class="justify-between">Profile</a></li>
          <li class="text-error"><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </div>
    {% else %}
      <a href="/"><button class="btn btn-ghost">Login</button></a>
    {% endif %}
  </div>
</div>

<div class="flex min-h-screen max-w-7xl mx-auto">
 <!-- Toggle Button -->
<button id="toggle-widget" class="fixed bottom-4 right-4 btn btn-primary z-50">
  Open Goal Widget
</button>

<!-- Widget Container -->
<div id="goal-widget" class="w-96 z-40 fixed p-6 overflow-y-auto 
            bottom-1/2 left-1/2 translate-x-[-50%] translate-y-[50%] 
            lg:top-16 lg:bottom-0 lg:left-auto lg:translate-x-0 lg:translate-y-0 hidden">

  <div class="card bg-base-200 shadow-lg sticky top-6">
    <div class="card-body space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="card-title text-lg">Set a New Goal</h2>
        <button onclick="toggleWidget()" class="btn btn-sm btn-ghost text-error">âœ–</button>
      </div>

      <input id="goal-title" type="text" placeholder="Goal Title" class="input input-bordered w-full" />
      <div class="form-control flex flex-col gap-2">
        <label class="label cursor-pointer">
          <input type="radio" name="difficulty" value="easy" class="radio radio-success" checked onclick="selectDifficulty('easy')" />
          <span class="label-text text-success flex items-center justify-center gap-1">Easy - 100 <img src="/static/images/money-icon.png" alt="currency icon" class="inline-block w-6 h-6" /></span>
        </label>
        <label class="label cursor-pointer">
          <input type="radio" name="difficulty" value="medium" class="radio radio-warning" onclick="selectDifficulty('medium')" />
          <span class="label-text text-warning flex items-center justify-center gap-1">Medium - 250 <img src="/static/images/money-icon.png" alt="currency icon" class="inline-block w-6 h-6" /></span>
        </label>
        <label class="label cursor-pointer">
          <input type="radio" name="difficulty" value="hard" class="radio radio-error" onclick="selectDifficulty('hard')" />
          <span class="label-text text-error flex items-center justify-center gap-1">Hard - 500 <img src="/static/images/money-icon.png" alt="currency icon" class="inline-block w-6 h-6" /></span>
        </label>
      </div>
      <input type="hidden" id="difficulty-value" value="easy" />
      <textarea class="textarea textarea-bordered w-full" placeholder="Goal Description"></textarea>
      <div class="card-actions justify-end">
        <button onclick="addGoal()" class="btn btn-info w-full">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Add Goal
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Script to Toggle -->
<script>
  const widget = document.getElementById("goal-widget");
  const toggleBtn = document.getElementById("toggle-widget");

  function toggleWidget() {
    widget.classList.toggle("hidden");
    toggleBtn.textContent = widget.classList.contains("hidden") ? "Open Goal Widget" : "Close Goal Widget";
  }

  toggleBtn.addEventListener("click", toggleWidget);
</script>


  <div class="lg:ml-96 mt-24 w-full p-6 overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 inline-block">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
      </svg>
      Current Goals
    </h2>
    <div id="goal-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for goal in goals %}
        <div class="card bg-base-200 shadow-md" data-goal-id="{{ goal.id }}">
          <div class="card-body space-y-3">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold">{{ goal.title }}</h3>
              <div class="badge badge-outline 
                {% if goal.difficulty == 'easy' %}text-success
                {% elif goal.difficulty == 'medium' %}text-warning
                {% else %}text-error{% endif %} 
                text-sm py-2">
                {{ goal.difficulty | capitalize }} - {{ goal.points }} coins
              </div>
            </div>
            <p class="text-sm text-gray-400">{{ goal.description or '' }}</p>
            <div class="flex justify-between items-center pt-2">
              <label class="label cursor-pointer">
                <span class="label-text text-sm text-white">{{ goal.status | replace('_', ' ') | capitalize }}</span>
                <input type="checkbox" class="toggle toggle-success ml-2" 
                  {% if goal.status == 'in_progress' %}checked{% endif %}
                  {% if goal.status == 'completed' %}disabled{% endif %}
                  onchange="toggleGoalStatus({{ goal.id }}, this.checked)" />
              </label>
              <div class="flex gap-2">
                <button id="confetti" class="btn btn-success btn-sm" 
                  onclick="completeGoal({{ goal.id }})" 
                  {% if goal.status == 'completed' %}disabled{% endif %}>
                  Mark Finished
                </button>
                <button class="btn btn-sm btn-error" onclick="deleteGoal({{ goal.id }})">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script src="/static/scripts/confetti.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const flash = document.getElementById('flash-message');
  if (flash) {
    setTimeout(() => {
      flash.classList.add('opacity-0');
      setTimeout(() => {
        flash.remove();
      }, 1000);
    }, 3000);
  }
});

function selectDifficulty(value) {
  document.getElementById('difficulty-value').value = value;
}

function addGoal() {
  const goalTitleText = document.querySelector('#goal-title');
  const descInput = document.querySelector('textarea[placeholder="Goal Description"]');
  const difficultyInput = document.querySelector('#difficulty-value');
  
  const title = goalTitleText.value.trim();
  const desc = descInput.value.trim();
  const difficulty = difficultyInput.value;

  if (!title) {
    goalTitleText.classList.add('input-error');
    goalTitleText.placeholder = "Title required!";
    setTimeout(() => {
      goalTitleText.classList.remove('input-error');
      goalTitleText.placeholder = "Goal Title";
    }, 1500);
    return;
  }

  fetch('/add_goal', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      title: title,
      description: desc,
      difficulty: difficulty
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    
    const goalContainer = document.querySelector('#goal-container');
    const textClass = {
      'easy': 'text-success',
      'medium': 'text-warning',
      'hard': 'text-error'
    }[difficulty];

    const goalCard = document.createElement('div');
    goalCard.className = 'card bg-base-200 shadow-md';
    goalCard.dataset.goalId = data.goal.id;
    goalCard.innerHTML = `
      <div class="card-body space-y-3">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">${data.goal.title}</h3>
          <div class="badge badge-outline ${textClass} text-sm py-2">
            ${data.goal.difficulty.charAt(0).toUpperCase() + data.goal.difficulty.slice(1)} - ${data.goal.points} pts
          </div>
        </div>
        <p class="text-sm text-gray-400">${data.goal.description || ''}</p>
        <div class="flex justify-between items-center pt-2">
          <label class="label cursor-pointer">
            <span class="label-text text-sm text-white">${data.goal.status.replace('_', ' ').charAt(0).toUpperCase() + data.goal.status.replace('_', ' ').slice(1)}</span>
            <input type="checkbox" class="toggle toggle-success ml-2" onchange="toggleGoalStatus(${data.goal.id}, this.checked)" />
          </label>
          <div class="flex gap-2">
            <button id='confetti' class="btn btn-success btn-sm" onclick="completeGoal(${data.goal.id})">Mark Finished</button>
            <button class="btn btn-sm btn-error" onclick="deleteGoal(${data.goal.id})">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
    goalContainer.prepend(goalCard);

    goalTitleText.value = '';
    descInput.value = '';
    document.getElementById('difficulty-value').value = 'easy';
    document.querySelector('input[name="difficulty"][value="easy"]').checked = true;
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to add goal');
  });
}

function deleteGoal(goalId) {
  if (!confirm('Are you sure you want to delete this goal?')) return;
  
  fetch(`/delete_goal/${goalId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    const goalCard = document.querySelector(`[data-goal-id="${goalId}"]`);
    if (goalCard) goalCard.remove();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to delete goal');
  });
}

function completeGoal(goalId) {
  fetch(`/complete_goal/${goalId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    
    const goalCard = document.querySelector(`[data-goal-id="${goalId}"]`);
    if (goalCard) {
      const statusSpan = goalCard.querySelector('.label-text');
      const toggle = goalCard.querySelector('.toggle');
      const completeButton = goalCard.querySelector('.btn-success');
      
      statusSpan.textContent = 'Completed';
      toggle.checked = true;
      toggle.disabled = true;
      completeButton.disabled = true;

      // Update points in navbar
      const pointsDisplay = document.getElementById('points-display');
      if (pointsDisplay) {
        pointsDisplay.textContent = data.new_points;
      }

      // Trigger confetti
      let confetti = new Confetti('confetti');
      confetti.setCount(75);
      confetti.setSize(1);
      confetti.setPower(25);
      confetti.setFade(false);
      confetti.destroyTarget(true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to complete goal');
  });
}

function toggleGoalStatus(goalId, isChecked) {
  const newStatus = isChecked ? 'in_progress' : 'not_started';
  
  fetch(`/update_goal_status/${goalId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ status: newStatus })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      const toggle = document.querySelector(`[data-goal-id="${goalId}"] .toggle`);
      toggle.checked = !isChecked; // Revert toggle on error
      return;
    }
    
    const goalCard = document.querySelector(`[data-goal-id="${goalId}"]`);
    if (goalCard) {
      const statusSpan = goalCard.querySelector('.label-text');
      statusSpan.textContent = data.status.replace('_', ' ').charAt(0).toUpperCase() + data.status.replace('_', ' ').slice(1);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update goal status');
    const toggle = document.querySelector(`[data-goal-id="${goalId}"] .toggle`);
    toggle.checked = !isChecked; // Revert toggle on error
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script>
function deleteMessage(messageId) {
  fetch(`/delete_message/${messageId}`, {
    method: 'POST'
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchMessages();
      }
    })
    .catch(error => console.error('Error deleting message:', error));
}

function RemoveFriend(friendId) {
  fetch(`/remove_friend/${friendId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchRecentMessages();
        fetchFriendSuggestions();
        if (friendId === activeFriendId) {
          window.location.href = '/chat';
        }
      } else {
        alert('Error removing friend: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error removing friend:', error);
      alert('Error removing friend');
    });
}

function leaveGroup(groupId) {
  fetch(`/leave_group/${groupId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchRecentMessages();
        if (groupId === activeGroupId) {
          window.location.href = '/chat';
        }
      } else {
        alert('Error leaving group: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error leaving group:', error);
      alert('Error leaving group');
    });
}

function renameGroup(groupId) {
  const newName = prompt('Enter new group name:');
  if (newName && newName.trim()) {
    fetch(`/rename_group/${groupId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ name: newName.trim() })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          fetchRecentMessages();
          if (groupId === activeGroupId) {
            document.querySelector('#conversation .text-center h2').textContent = newName.trim();
          }
        } else {
          alert('Error renaming group: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error renaming group:', error);
        alert('Error renaming group');
      });
  }
}

function toggleAccountabilityPartner(friendId) {
  fetch(`/toggle_accountability_partner/${friendId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchRecentMessages();
        fetchFriendSuggestions();
        alert(`Accountability partner status ${data.is_now_partner ? 'added' : 'removed'} successfully`);
      } else {
        alert('Error toggling accountability partner: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error toggling accountability partner:', error);
      alert('Error toggling accountability partner');
    });
}

function checkAccountabilityPartner(friendId, friendName) {
    fetch(`/is_accountability_partner/${friendId}`)
      .then(response => response.json())
      .then(data => {
        if (data.is_accountability_partner) {
          window.location.href = `/accountability/${friendName}`;
        }
      })
      .catch(error => console.error('Error checking accountability partner:', error));
}

function handleFriendRequest(requestId, action) {
  fetch(`/handle_friend_request/${requestId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ action: action })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchFriendRequests();
        fetchFriendSuggestions();
        if (action === 'accept') {
          fetchRecentMessages();
        }
      }
    })
    .catch(error => console.error('Error handling friend request:', error));
}

function sendFriendSuggestionRequest(userId) {
  fetch('/send_friend_request_by_id', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ receiver_id: userId })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchFriendSuggestions();
        fetchRecentMessages();
        alert(data.message);
      } else {
        alert(data.error || 'Error sending friend request');
      }
    })
    .catch(error => {
      console.error('Error sending friend request:', error);
      alert('Error sending friend request');
    });
}

function removeFriendSuggestion(userId) {
  fetch(`/remove_friend_suggestion/${userId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetchFriendSuggestions();
      } else {
        alert(data.error || 'Error removing friend suggestion');
      }
    })
    .catch(error => {
      console.error('Error removing friend suggestion:', error);
      alert('Error removing friend suggestion');
    });
}

document.addEventListener('DOMContentLoaded', function () {
  const flash = document.getElementById('flash-message');
  if (flash) {
    setTimeout(() => {
      flash.classList.add('opacity-0');
      setTimeout(() => flash.remove(), 1000);
    }, 3000);
  }

  const activeFriendId = {% if active_friend %}{{ active_friend.id }}{% else %}null{% endif %};
  const activeGroupId = {% if active_group %}{{ active_group.id }}{% else %}null{% endif %};
  const messagesContainer = document.getElementById("messages-container");
  const fileInput = document.getElementById("fileInput");
  const previewContainer = document.getElementById("previewContainer");
  let lastMessageIds = [];
  const modalContainer = document.body;
  const createdModals = new Set();

  function createModal(msg) {
    if (!createdModals.has(msg.id)) {
      const modal = document.createElement("dialog");
      modal.id = `my_modal_${msg.id}`;
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-box p-4">
          <img src="${msg.file_path}" alt="Full-size image" class="w-125 h-auto rounded-lg" />
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      `;
      modalContainer.appendChild(modal);
      createdModals.add(msg.id);
    }
  }

  function clearUnusedModals(currentMessageIds) {
    const modalIds = Array.from(createdModals).map(id => `my_modal_${id}`);
    modalIds.forEach(modalId => {
      if (!currentMessageIds.includes(parseInt(modalId.replace('my_modal_', '')))) {
        const modal = document.getElementById(modalId);
        if (modal) modal.remove();
        createdModals.delete(parseInt(modalId.replace('my_modal_', '')));
      }
    });
  }

  function fetchRecentMessages() {
    fetch('/recent_messages')
      .then(response => response.json())
      .then(data => {
        const recentMessagesList = document.getElementById('recent-messages');
        const searchInput = recentMessagesList.querySelector('.input-bordered');
        const createGroupButton = recentMessagesList.querySelector('.btn-ghost.btn-circle');
        const searchContainer = recentMessagesList.querySelector('.flex.justify-center.items-center');
        const suggestionsContainer = document.getElementById('friend-suggestions');
        const header = recentMessagesList.querySelector('li.p-4.pb-2');
        recentMessagesList.innerHTML = '';
        recentMessagesList.appendChild(searchContainer);
        recentMessagesList.appendChild(suggestionsContainer);
        recentMessagesList.appendChild(header);

        if (data.friends.length === 0 && data.groups.length === 0) {
          const li = document.createElement('li');
          li.className = 'text-center text-sm opacity-60';
          li.textContent = 'No friends or groups yet';
          recentMessagesList.appendChild(li);
        } else {
          // Display friends
          data.friends.forEach(friend => {
            const li = document.createElement('li');
            li.className = `py-2 w-full px-4 ${activeFriendId === friend.friend_id ? 'bg-base-300' : ''}`;
            li.innerHTML = `
              <div class='flex flex-row items-center gap-2 justify-between'>
                <a href="/chat/${friend.friend_id}">
                  <div class='flex flex-row items-center gap-4 justify-between'>
                    <div class="avatar">
                      <div class="w-10 rounded-full">
                        <img src="${friend.profile_photo}" alt="${friend.friend_name || 'Friend'}"/>
                      </div>
                    </div>
                    <div>
                      <div class="${friend.is_accountability_partner ? 'text-success' : ''}">${friend.friend_name || 'Unknown'}</div>
                      <div id="friend-${friend.friend_id}-message" class="text-xs font-semibold opacity-60">${friend.message || '[File]'}</div>
                    </div>
                  </div>
                </a>
                <div class="dropdown dropdown-right dropdown-center">
                  <div tabindex="0" role="button" class="btn m-1 btn-square btn-ghost">
                    <svg class="size-[1.2em]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
                    <li><a onclick="toggleAccountabilityPartner(${friend.friend_id})">${friend.is_accountability_partner ? 'Remove Accountability Partner' : 'Make Accountability Partner'}</a></li>
                    <li><a onclick="checkAccountabilityPartner(${friend.friend_id}, '${friend.friend_name}'); cancelRedirect(event);">View stats</a></li>
                    <li onclick="RemoveFriend(${friend.friend_id})"><a class='text-error'>Unfriend</a></li>
                  </ul>
                </div>
              </div>
            `;
            recentMessagesList.appendChild(li);
          });

          // Display groups
          data.groups.forEach(group => {
            const li = document.createElement('li');
            li.className = `py-2 w-full px-4 ${activeGroupId === group.group_id ? 'bg-base-300' : ''}`;
            li.innerHTML = `
              <div class='flex flex-row items-center gap-2 justify-between'>
                <a href="/group_chat/${group.group_id}">
                  <div class='flex flex-row items-center gap-4 justify-between'>
                    <div class="avatar">
                      <div class="w-10 rounded-full">
                        <img src="/static/images/chat-icon.png" alt="${group.group_name || 'Group'}"/>
                      </div>
                    </div>
                    <div>
                      <div>${group.group_name || 'Unnamed Group'}</div>
                      <div id="group-${group.group_id}-message" class="text-xs font-semibold opacity-60">${group.message || '[File]'}</div>
                    </div>
                  </div>
                </a>
                <div class="dropdown dropdown-right dropdown-center">
                  <div tabindex="0" role="button" class="btn m-1 btn-square btn-ghost">
                    <svg class="size-[1.2em]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
                      ${group.is_creator 
                        ? `
                          <li><a onclick="renameGroup(${group.group_id})">Rename Group</a></li>
                          <li><a class='text-error' onclick="deleteGroup(${group.group_id})">Delete Group</a></li>
                        ` 
                        : `<li><a class='text-error' onclick="leaveGroup(${group.group_id})">Leave Group</a></li>`
                      }
                    </ul>
                </div>
              </div>
            `;
            recentMessagesList.appendChild(li);
          });
        }

        const newSearchInput = document.getElementById('search-users');
        const friendItems = recentMessagesList.querySelectorAll('li:not(.p-4.pb-2):not(#suggested-friends li)');
        newSearchInput.addEventListener('input', function () {
          const searchTerm = this.value.trim().toLowerCase();
          friendItems.forEach(item => {
            const name = item.querySelector('div > div > div:first-child').textContent.toLowerCase();
            item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
          });
          if (!searchTerm) {
            friendItems.forEach(item => item.style.display = 'flex');
          }
        });
      })
      .catch(error => console.error('Error fetching recent messages:', error));
  }

  function fetchFriendSuggestions() {
    fetch('/get_friend_suggestions')
      .then(response => response.json())
      .then(data => {
        const suggestionsList = document.getElementById('suggested-friends');
        const suggestionsContainer = document.getElementById('friend-suggestions');
        suggestionsList.innerHTML = '';
        if (data.length === 0) {
          suggestionsContainer.style.display = 'none';
        } else {
          suggestionsContainer.style.display = 'block';
          data.slice(0, 3).forEach(user => {
            const li = document.createElement('li');
            li.className = 'p-2 flex justify-between items-start';
            li.innerHTML = `
              <div class='flex justify-between w-full'>
                <div class='flex flex-col items-start gap-1'>
                  <span>${user.name}</span>
                  <span class='truncate'>${user.email}</span>
                </div>
                <div class='flex items-end gap-2'>
                  <button class="btn btn-xs btn-success mr-2" onclick="sendFriendSuggestionRequest(${user.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </button>
                  <button class="btn btn-xs btn-error" onclick="removeFriendSuggestion(${user.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </button>
                </div>
              </div>
            `;
            suggestionsList.appendChild(li);
          });
        }
      })
      .catch(error => console.error('Error fetching friend suggestions:', error));
  }

  function fetchFriendRequests() {
    fetch('/get_friend_requests')
      .then(response => response.json())
      .then(data => {
        const friendRequestsList = document.getElementById('friend-requests');
        const requestCountBadge = document.getElementById('request-count-badge');
        friendRequestsList.innerHTML = '';
        if (data.length === 0) {
          friendRequestsList.innerHTML = '<li class="text-center text-sm opacity-60">No friend requests</li>';
          requestCountBadge.style.display = 'none';
        } else {
          requestCountBadge.style.display = 'block';
          requestCountBadge.textContent = data.length;
          data.forEach(request => {
            const li = document.createElement('li');
            li.className = 'p-2 flex justify-between items-start';
            li.innerHTML = `
              <div class='flex justify-between w-full'>
                <div class='flex flex-col items-start gap-1'>
                  <span>${request.sender_name}</span>
                  <span class='truncate'>${request.sender_email}</span>
                </div>
                <div class='flex items-end gap-2'>
                  <button class="btn btn-xs btn-success mr-2" onclick="handleFriendRequest(${request.id}, 'accept')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </button>
                  <button class="btn btn-xs btn-error" onclick="handleFriendRequest(${request.id}, 'reject')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </button>
                </div>
              </div>
            `;
            friendRequestsList.appendChild(li);
          });
        }
      })
      .catch(error => console.error('Error fetching friend requests:', error));
  }

  function fetchOutgoingRequests() {
    fetch('/get_outgoing_requests')
      .then(response => response.json())
      .then(data => {
        const outgoingList = document.getElementById('outgoing-requests');
        outgoingList.innerHTML = '';
        if (data.length === 0) {
          outgoingList.innerHTML = '<li class="text-center text-sm opacity-60">No outgoing requests</li>';
        } else {
          data.forEach(request => {
            const li = document.createElement('li');
            li.className = 'p-2 flex justify-between items-center';
            li.innerHTML = `
              <span>${request.receiver_name} (${request.receiver_email})</span>
              <span id='request-time' class="text-xs opacity-60">${request.timestamp}</span>
            `;
            outgoingList.appendChild(li);
          });
        }
      })
      .catch(error => console.error('Error fetching outgoing requests:', error));
  }

  const addFriendsTab = document.getElementById('tab-add-friends');
  const outgoingRequestsTab = document.getElementById('tab-outgoing-requests');
  const addFriendsContent = document.getElementById('add-friends-content');
  const outgoingRequestsContent = document.getElementById('outgoing-requests-content');

  if (addFriendsTab && outgoingRequestsTab) {
    addFriendsTab.addEventListener('change', () => {
      addFriendsContent.classList.remove('hidden');
      outgoingRequestsContent.classList.add('hidden');
    });
    outgoingRequestsTab.addEventListener('change', () => {
      addFriendsContent.classList.add('hidden');
      outgoingRequestsContent.classList.remove('hidden');
      fetchOutgoingRequests();
    });
  }

  const createGroupForm = document.getElementById('create-group-form');
  if (createGroupForm) {
    createGroupForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const groupName = document.getElementById('group-name').value.trim();
      const groupMembers = Array.from(document.querySelectorAll('#friend-selection-container input[name="group-members"]:checked')).map(checkbox => parseInt(checkbox.value));
      
      if (!groupName) {
        alert('Please enter a group name');
        return;
      }
      if (groupMembers.length === 0) {
        alert('Please select at least one friend');
        return;
      }

      fetch('/create_group', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: groupName,
          members: groupMembers
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            fetchRecentMessages();
            document.getElementById('group-name').value = '';
            document.querySelectorAll('#friend-selection-container input[name="group-members"]').forEach(checkbox => checkbox.checked = false);
            document.getElementById('create-group-modal').close();
            alert('Group created successfully!');
          } else {
            alert('Error creating group: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error creating group:', error);
          alert('Error creating group');
        });
    });
  }

  if (activeFriendId || activeGroupId) {
    const input = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");

    function sendMessage(content, files) {
      const formData = new FormData();
      formData.append("content", content);
      if (activeFriendId) {
        formData.append("recipient_id", activeFriendId);
      } else {
        formData.append("group_id", activeGroupId);
      }
      for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
      }

      fetch("/send_message", {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            fetchMessages();
            input.value = "";
            fileInput.value = "";
            previewContainer.innerHTML = "";
          } else {
            console.error('Error sending message:', data.error);
            alert('Failed to send message: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error sending message');
        });
    }

    function fetchMessages() {
      const url = activeFriendId ? `/get_messages/${activeFriendId}` : `/get_group_messages/${activeGroupId}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data)) {
            displayMessages(data);
          } else {
            console.error('Error fetching messages:', data.error);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function displayMessages(messages) {
      const currentMessageIds = messages.map(msg => msg.id);
      lastMessageIds = currentMessageIds;
      clearUnusedModals(currentMessageIds);

      let newContent = "";
      messages.forEach(msg => {
        const chatDiv = document.createElement("div");
        chatDiv.className = msg.is_mine ? "chat chat-end group relative" : "chat chat-start group relative";

        const utcTime = msg.timestamp;
        const [utcHours, utcMinutes] = utcTime.split(':').map(Number);
        const now = new Date();
        const utcDate = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), utcHours, utcMinutes));
        const localHours = utcDate.getHours().toString().padStart(2, '0');
        const localMinutes = utcDate.getMinutes().toString().padStart(2, '0');
        const localTime = `${localHours}:${localMinutes}`;

        const deleteButton = msg.is_mine ? `
          <button class="btn btn-xs btn-square btn-ghost absolute top-1/2 -translate-y-1/2 hidden group-hover:flex text-error" style="left: -30px;" onclick="deleteMessage(${msg.id})">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
          </button>
        ` : '';

        let contentHtml = '';
        if (msg.file_path) {
          const fileExt = msg.file_path.split('.').pop().toLowerCase();
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt);
          if (isImage) {
            contentHtml += `
              <div class="chat-bubble relative">
                <img src="${msg.file_path}" alt="Shared image" style="max-w-[250px] h-[250px] object-cover w-full" class="rounded-lg cursor-pointer" onclick="document.getElementById('my_modal_${msg.id}').showModal()" />
                ${deleteButton}
              </div>`;
            createModal(msg);
          } else {
            const fileName = msg.file_path.split('/').pop();
            let fileSize = "Unknown size";
            if (msg.file_size && !isNaN(parseInt(msg.file_size, 10))) {
              const bytes = parseInt(msg.file_size, 10);
              const units = ["Bytes", "KB", "MB", "GB", "TB"];
              let size = bytes;
              let unitIndex = 0;
              while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
              }
              fileSize = `${size.toFixed(2)} ${units[unitIndex]}`;
            }
            contentHtml += `
              <div class="chat-bubble flex items-center justify-center text-xs relative">
                <a href="${msg.file_path}" download>
                  <div id="file_attatchment" class="w-[200px] border bg-base-100 m-4 h-16 rounded-lg flex items-center justify-around cursor-pointer px-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-icon lucide-file">
                      <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
                      <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
                    </svg>
                    <div class="h-[36px] max-w-[110px] w-full overflow-hidden flex flex-col items-start justify-center">
                      <p class="truncate text-sm w-full block" id="file_name_attatchment" title="${fileName}">
                        ${fileName}
                      </p>
                      <p id="file_size_attatchment" class="text-neutral-content text-xs">${fileSize}</p>
                    </div>
                  </div>
                </a>
                ${deleteButton}
              </div>`;
          }
        } else {
          contentHtml = `
            <div class="chat-bubble relative">
              ${msg.content}
              ${deleteButton}
            </div>`;
        }

        chatDiv.innerHTML = `
          <div class="chat-image avatar">
            <div class="w-10 rounded-full">
              <img alt="${msg.sender_name}" src="${msg.sender_profile_photo}" />
            </div>
          </div>
          <div class="chat-header">
            ${msg.sender_name}
            <time class="text-xs opacity-50">${localTime}</time>
          </div>
          ${contentHtml}
          <div class="chat-footer opacity-50">${msg.status || 'delivered'}</div>
        `;
        newContent += chatDiv.outerHTML;
      });

      messagesContainer.innerHTML = newContent;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    input.addEventListener("keypress", function (e) {
      if (e.key === "Enter" && (input.value.trim() || fileInput.files.length > 0)) {
        sendMessage(input.value, fileInput.files);
      }
    });

    sendButton.addEventListener("click", function() {
      if (input.value.trim() || fileInput.files.length > 0) {
        sendMessage(input.value, fileInput.files);
      }
    });

    setInterval(fetchMessages, 2000);
    fetchMessages();
  }

  setInterval(fetchFriendRequests, 5000);
  setInterval(fetchRecentMessages, 3000);
  setInterval(fetchFriendSuggestions, 5000);
  fetchFriendRequests();
  fetchRecentMessages();
  fetchFriendSuggestions();
});

const fileButton = document.getElementById('fileButton');
const fileInput = document.getElementById('fileInput');
if (fileButton && fileInput) {
  fileButton.addEventListener('click', () => fileInput.click());
}

document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById("fileInput");
  const container = document.getElementById("previewContainer");

  if (fileInput && container) {
    fileInput.addEventListener("click", function() {
      this.value = "";
    });

    fileInput.addEventListener("change", function(event) {
      const files = event.target.files;
      const conversation = document.getElementById("conversation");
      conversation.classList.add("mb-[176px]");
      
      Array.from(files).forEach(file => {
        const indicator = document.createElement("div");
        indicator.className = "indicator my-4";

        const badge = document.createElement("span");
        badge.className = "indicator-item badge badge-error cursor-pointer";
        badge.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
        `;
        badge.addEventListener("click", () => {
          indicator.remove();
          const dt = new DataTransfer();
          Array.from(fileInput.files)
            .filter(f => f !== file)
            .forEach(f => dt.items.add(f));
          fileInput.files = dt.files;
          if (fileInput.files.length === 0) {
            conversation.classList.remove("mb-[176px]");
          }
        });

        const wrapper = document.createElement("div");
        wrapper.className = "flex flex-col items-center justify-center w-36 h-36 border-1 border-gray-500 p-2 py-8 bg-base-100 rounded-lg overflow-hidden";

        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "w-full h-full object-contain bg-gray-800 rounded-lg my-2";
            const p = document.createElement("p");
            p.innerHTML = file.name;
            p.className = "text-white text-xs w-full truncate flex-shrink-0";
            wrapper.appendChild(img);
            wrapper.appendChild(p);
            indicator.appendChild(badge);
            indicator.appendChild(wrapper);
            container.appendChild(indicator);
          };
          reader.readAsDataURL(file);
        } else {
          const svgWrapper = document.createElement("div");
          svgWrapper.className = "w-full h-full bg-gray-800 rounded-lg flex items-center justify-center my-2";
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
              <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
            </svg>`, "image/svg+xml");
          const svg = svgDoc.documentElement;
          svg.style.width = "60%";
          svg.style.height = "60%";
          svg.style.display = "block";
          svgWrapper.appendChild(svg);
          const p = document.createElement("p");
          p.innerHTML = file.name;
          p.className = "text-white text-xs w-full truncate flex-shrink-0";
          wrapper.appendChild(svgWrapper);
          wrapper.appendChild(p);
          indicator.appendChild(badge);
          indicator.appendChild(wrapper);
          container.appendChild(indicator);
        }
      });
    });
  }
});

const friendId = {{ active_friend.id if active_friend else 'null' }};
const groupId = {{ active_group.id if active_group else 'null' }};
if (friendId !== null || groupId !== null) {
  function markMessagesAsSeen() {
    const url = friendId ? `/mark_seen/${friendId}` : `/mark_group_seen/${groupId}`;
    fetch(url, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Messages marked as seen');
          fetchMessages();
        }
      })
      .catch(error => console.error('Error marking messages as seen:', error));
  }
  markMessagesAsSeen();
  setInterval(() => markMessagesAsSeen(), 5000);
}
</script>
<script>
  const emojiSelectorIcon = document.getElementById('emojiSelectorIcon');
  const emojiSelector = document.getElementById('emojiSelector');
  const emojiList = document.getElementById('emojiList');
  const emojiSearch = document.getElementById('emojiSearch');
  const messageInput = document.getElementById('message-input');

  if (emojiSelectorIcon && emojiSelector && emojiList && emojiSearch && messageInput) {
    emojiSelectorIcon.addEventListener('click', () => {
      emojiSelector.classList.toggle('active');
    });

    fetch('/get-emojis')
      .then(res => res.json())
      .then(data => {
        loadEmoji(data);
      })
      .catch(err => console.log('Error:', err.message));

    function loadEmoji(data) {
      emojiList.innerHTML = '';
      data.forEach(emoji => {
        let li = document.createElement('li');
        li.setAttribute('emoji-name', emoji.slug);
        li.textContent = emoji.character;
        li.addEventListener('click', () => {
          const currentValue = messageInput.value;
          const selectionStart = messageInput.selectionStart;
          const selectionEnd = messageInput.selectionEnd;
          messageInput.value = currentValue.substring(0, selectionStart) + emoji.character + currentValue.substring(selectionEnd);
          const newCursorPos = selectionStart + emoji.character.length;
          messageInput.setSelectionRange(newCursorPos, newCursorPos);
          messageInput.focus();
          emojiSelector.classList.remove('active');
        });
        emojiList.appendChild(li);
      });
    }

    emojiSearch.addEventListener('keyup', e => {
      let value = e.target.value.toLowerCase();
      let emojis = emojiList.querySelectorAll('#emojiList li');

      emojis.forEach(emoji => {
        if (emoji.getAttribute('emoji-name').toLowerCase().includes(value)) {
          emoji.style.display = 'flex';
        } else {
          emoji.style.display = 'none';
        }
      });
    });
  }

  function cancelRedirect(event) {
    event.stopPropagation(); 
  }
</script>
<script>
  function updateLogoText() {
    const logo = document.getElementById("logo");
    if (window.innerWidth >= 1024) {
      logo.textContent = "CodeConnect/goals";
    } else {
      logo.textContent = "CodeConnect";
    }
  }

  // Run on load
  updateLogoText();

  // Optional: Update on resize
  window.addEventListener("resize", updateLogoText);
</script>
</body>
</html>